<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meet Results | Mountain State Miles</title>
  
  <!-- Favicon Links -->
  <link rel="icon" type="image/png" href="../assets/Favicon Generator/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="../assets/Favicon Generator/favicon.svg" />
  <link rel="shortcut icon" href="../assets/Favicon Generator/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="../assets/Favicon Generator/apple-touch-icon.png" />
  <link rel="manifest" href="../assets/Favicon Generator/site.webmanifest" />
  
  <meta name="description" content="Track & field results, times, rankings, and meet data ‚Äî Mountain State Miles." />
  <meta name="keywords" content="WV Track, Track Results, West Virginia Running, Track & Field, Mountain State Miles" />
  <meta name="author" content="Mountain State Miles" />
  <link rel="stylesheet" href="/assets/main.css">
  
  <!-- URL Parameter Script in the Head -->
  <script>
    window.addEventListener("DOMContentLoaded", () => {
      const params = new URLSearchParams(window.location.search);
      const slug = params.get("slug");
      if (slug) {
        document.title = `${slug.replace(/-/g, " ")} ‚Äì Meet Results | Mountain State Miles`;
      }
    });
  </script>

  <style>
    #selector {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin: 30px 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .tabs-row {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 2px solid #e0e0e0;
    }

    .gender-tab {
      padding: 12px 24px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      color: #666;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
    }

    .gender-tab:hover {
      color: var(--secondary);
    }

    .gender-tab.active {
      color: var(--secondary);
      border-bottom-color: var(--secondary);
    }

    #select-heading {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 8px;
    }

    #select-sub {
      font-size: 0.95rem;
      color: #666;
      margin-bottom: 20px;
    }

    .race-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
    }

    .race-button {
      padding: 12px 16px;
      border: 2px solid #ddd;
      background: white;
      color: #666;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      font-size: 0.95rem;
    }

    .race-button:hover {
      border-color: var(--secondary);
      color: var(--secondary);
    }

    .race-button.primary {
      background: var(--secondary);
      color: white;
      border-color: var(--secondary);
    }

    .race-button.secondary {
      background: white;
      color: #666;
      border-color: #ddd;
    }

    .results-box {
      margin-top: 30px;
    }

    .results-table-container {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 30px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      overflow-x: auto;
    }

    .results-table-container h3 {
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--primary);
    }

    .results-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }

    .results-table thead {
      background: var(--primary);
      color: white;
    }

    .results-table th {
      padding: 14px 16px;
      text-align: left;
      font-weight: 700;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border: none;
    }

    .results-table tbody tr {
      border-bottom: 1px solid #e0e0e0;
      transition: background 0.2s;
    }

    .results-table tbody tr:hover {
      background: #f8f9fa;
    }

    .results-table td {
      padding: 14px 16px;
      border: none;
    }

    .results-table td[data-label]::before {
      content: attr(data-label);
      font-weight: 700;
      color: #666;
      display: none;
    }

    .results-table a {
      color: var(--secondary);
      text-decoration: none;
      font-weight: 600;
      transition: color 0.2s;
    }

    .results-table a:hover {
      color: var(--primary);
      text-decoration: underline;
    }

    #error {
      background: #fff3cd;
      border: 1px solid #ffc107;
      color: #856404;
      padding: 16px;
      border-radius: 8px;
      margin: 20px 0;
      display: none;
    }

    #error.show {
      display: block;
    }

    @media (max-width: 768px) {
      .race-buttons {
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      }

      .results-table {
        font-size: 0.85rem;
      }

      .results-table th,
      .results-table td {
        padding: 10px 8px;
      }

      .results-table-container {
        padding: 16px;
      }
    }
  </style>
</head>

<body>
  <header>
    <nav class="navbar">
      <div class="navbar-content">
        <a href="index.html" class="navbar-brand">‚ö° Track & Field</a>
        <button class="mobile-menu-toggle" aria-label="Toggle menu">‚ò∞</button>
        <ul class="navbar-nav" id="main-nav">
          <li><a href="/home/index.html" class="navbar-link">Home</a></li>
          <li><a href="index.html" class="navbar-link">Track</a></li>
          <li><a href="meets.html" class="navbar-link active">Meets</a></li>
          <li><a href="events.html" class="navbar-link">Events</a></li>
          <li><a href="rankings.html" class="navbar-link">Rankings</a></li>
          <li><a href="analytics.html" class="navbar-link">Analytics</a></li>
        </ul>
        <button class="theme-toggle" aria-label="Switch theme">üåô</button>
      </div>
    </nav>
    <div class="content-section" style="padding-top: 0.5rem; padding-bottom: 0.5rem;">
      <a href="meets.html" class="btn btn-sm">‚Üê Back to Meets</a>
    </div>
  </header>

  <main class="content-section">
    <h1 id="meet-title">Meet Results</h1>
    <div id="meet-meta" class="meet-metadata"></div>
    <div id="weather-widget" class="weather-widget" style="display:none;"></div>
    <div id="error" class="error-message"></div>

    <div id="selector" style="display:none;">
      <div class="tabs-row" role="tablist" aria-label="Gender tabs">
        <button id="tab-mens" class="gender-tab active">MEN</button>
        <button id="tab-womens" class="gender-tab">WOMEN</button>
      </div>
      <div id="select-heading">Select an Event</div>
      <div id="select-sub">Choose which event results you want to view for this meet.</div>
      <div id="event-button-wrap" class="race-buttons"></div>
    </div>

    <div id="results-box" class="results-box"></div>
  </main>

  <footer>
    <div class="row">
      <div class="footer-col">
        <h4>General</h4>
        <ul>
          <li><a href="/home/index.html">Home</a></li>
          <li><a href="/home/admin.html">Admin</a></li>
          <li><a href="/news.html">News</a></li>
        </ul>
      </div>

      <div class="footer-col">
        <h4>Cross Country</h4>
        <ul>
          <li><a href="/CrossCountry/xc.html">Home</a></li>
          <li><a href="/CrossCountry/meets.html">Meets</a></li>
          <li><a href="/CrossCountry/schools.html">Schools</a></li>
          <li><a href="/CrossCountry/rankings.html">Rankings</a></li>
          <li><a href="/CrossCountry/analytics.html">Analytics</a></li>
        </ul>
      </div>

      <div class="footer-col">
        <h4>Track</h4>
        <ul>
          <li><a href="/Track/index.html">Home</a></li>
          <li><a href="/Track/meets.html">Meets</a></li>
          <li><a href="/Track/teams.html">Teams</a></li>
          <li><a href="/Track/rankings.html">Rankings</a></li>
          <li><a href="/Track/analytics.html">Analytics</a></li>
        </ul>
      </div>
    </div>
    <hr>
    <div class="row">
      <div class="footer-bottom">
        <p>&#169; 2026 Mountain State Miles ‚Äî Built by runners, for runners.</p>
      </div>
    </div>
  </footer>

  <script src="/assets/theme-toggle.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="firebase-config.js"></script>

  <script>
    // ==========================================
    // UTILITY & FORMATTING FUNCTIONS
    // ==========================================

    function formatMark(mark, eventName = '') {
      if (!mark) return '‚Äî';
      return String(mark);
    }

    function slugify(name) {
      if (!name) return '';
      return name.toLowerCase().trim().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
    }

    // ==========================================
    // STATE MANAGEMENT
    // ==========================================
    
    let currentMeetData = null;
    let allResults = [];
    let activeGender = 'M';
    let activeEvent = null;

    // ==========================================
    // MAIN INITIALIZATION
    // ==========================================

    window.addEventListener("DOMContentLoaded", async () => {
      const params = new URLSearchParams(window.location.search);
      const slug = params.get("slug");

      const errorDiv = document.getElementById("error");
      const selectorDiv = document.getElementById("selector");

      if (!slug) {
        errorDiv.classList.add("show");
        errorDiv.textContent = "No meet specified. Please return to the Meets page.";
        return;
      }

      try {
        await waitForFirebase();

        // Load meet
        const meetsSnapshot = await window.firebaseDatabase.ref('Track/meets').once('value');
        meetsSnapshot.forEach(child => {
          const meetData = child.val();
          if (meetData.slug === slug || child.key === slug) {
            currentMeetData = { id: child.key, ...meetData };
          }
        });

        if (!currentMeetData) {
          throw new Error('Meet not found');
        }

        // Update header
        document.getElementById('meet-title').textContent = currentMeetData.name;
        document.getElementById('meet-meta').innerHTML = `
          <strong>Date:</strong> ${currentMeetData.date || 'TBA'} <span style="margin:0 10px">|</span> 
          <strong>Location:</strong> ${currentMeetData.location || 'Unknown'}
        `;

        // Load weather
        if (currentMeetData.location && currentMeetData.date) {
          loadWeatherForMeet(currentMeetData.location, currentMeetData.date);
        }

        // Load results
        const resultsSnapshot = await window.firebaseDatabase.ref('Track/results').once('value');
        const athletesSnapshot = await window.firebaseDatabase.ref('Track/athletes').once('value');
        const eventsSnapshot = await window.firebaseDatabase.ref('Track/events').once('value');

        const athletesMap = {};
        const eventsMap = {};

        athletesSnapshot.forEach(child => {
          athletesMap[child.key] = { id: child.key, ...child.val() };
        });

        eventsSnapshot.forEach(child => {
          eventsMap[child.key] = { id: child.key, ...child.val() };
        });

        resultsSnapshot.forEach(child => {
          const resultData = child.val();
          if (resultData.meet_id === currentMeetData.id) {
            const athlete = athletesMap[resultData.athlete_id] || {};
            const event = eventsMap[resultData.event_id] || {};
            allResults.push({
              id: child.key,
              ...resultData,
              athlete_name: `${athlete.first_name || ''} ${athlete.last_name || ''}`.trim(),
              athlete_school: athlete.school || '',
              event_name: event.name || 'Unknown',
              gender: event.gender || resultData.gender || ''
            });
          }
        });

        if (allResults.length === 0) {
          errorDiv.classList.add("show");
          errorDiv.textContent = 'No results uploaded yet for this meet.';
          return;
        }

        // Initialize UI
        selectorDiv.style.display = 'block';
        setupGenderTabs();
        document.getElementById('tab-mens').click();

      } catch (err) {
        console.error(err);
        errorDiv.classList.add("show");
        errorDiv.textContent = 'Error loading meet: ' + err.message;
      }
    });

    async function waitForFirebase() {
      let attempts = 0;
      while (typeof window.firebaseDatabase === 'undefined' && attempts < 50) {
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
      }
    }

    // ==========================================
    // UI LOGIC (TABS & BUTTONS)
    // ==========================================

    function setupGenderTabs() {
      const btnMens = document.getElementById('tab-mens');
      const btnWomens = document.getElementById('tab-womens');

      const resetTabs = () => {
        [btnMens, btnWomens].forEach(b => b.classList.remove('active'));
      };

      btnMens.addEventListener('click', () => {
        resetTabs();
        btnMens.classList.add('active');
        activeGender = 'M';
        updateEventButtons();
      });

      btnWomens.addEventListener('click', () => {
        resetTabs();
        btnWomens.classList.add('active');
        activeGender = 'W';
        updateEventButtons();
      });
    }

    function updateEventButtons() {
      const container = document.getElementById('event-button-wrap');
      container.innerHTML = '';
      document.getElementById('results-box').innerHTML = '';

      const relevantResults = allResults.filter(r => 
        (r.gender || '').toUpperCase() === activeGender
      );

      if (relevantResults.length === 0) {
        container.innerHTML = '<div style="color:#ccc; grid-column: 1/-1; text-align:center;">No events for this category.</div>';
        return;
      }

      const events = [...new Set(relevantResults.map(r => r.event_name))].sort();

      events.forEach((eventName, index) => {
        const btn = document.createElement('button');
        btn.className = 'race-button secondary';
        btn.textContent = eventName;

        btn.onclick = () => {
          Array.from(container.children).forEach(c => {
            c.classList.remove('primary');
            c.classList.add('secondary');
          });
          btn.classList.remove('secondary');
          btn.classList.add('primary');

          activeEvent = eventName;
          renderResultsForEvent();
        };

        container.appendChild(btn);

        if (index === 0) btn.click();
      });
    }

    function renderResultsForEvent() {
      const filteredResults = allResults.filter(r =>
        (r.gender || '').toUpperCase() === activeGender &&
        r.event_name === activeEvent
      );

      filteredResults.sort((a, b) => {
        const placeA = parseInt(a.placement) || 999;
        const placeB = parseInt(b.placement) || 999;
        if (placeA !== placeB) return placeA - placeB;
        return 0;
      });

      const teamScores = calculateTeamScores(filteredResults);

      renderResultsTable(filteredResults);
      if (teamScores.length > 0) {
        renderTeamResults(teamScores);
      }
    }

    function calculateTeamScores(results) {
      const teamMap = {};

      results.forEach(result => {
        const school = result.athlete_school || 'Unknown';
        if (!teamMap[school]) teamMap[school] = [];
        teamMap[school].push(result);
      });

      const scores = [];

      Object.entries(teamMap).forEach(([school, athletes]) => {
        const pointsTable = [0, 10, 8, 6, 4, 2, 1];
        let teamScore = 0;

        athletes.forEach(result => {
          const place = parseInt(result.placement);
          if (place >= 1 && place <= 6) {
            teamScore += pointsTable[place];
          }
        });

        scores.push({
          school,
          score: teamScore,
          athletes: athletes.length
        });
      });

      return scores.sort((a, b) => b.score - a.score);
    }

    function renderResultsTable(results) {
      const resultsBox = document.getElementById('results-box');

      if (!results || results.length === 0) {
        resultsBox.innerHTML = '<p>No results found.</p>';
        return;
      }

      const tableHTML = `
        <div class="results-table-container">
          <table class="results-table">
            <thead>
              <tr>
                <th>Place</th>
                <th>Athlete</th>
                <th>School</th>
                <th>Mark</th>
                <th>Heat</th>
              </tr>
            </thead>
            <tbody>
              ${results.map(result => `
                <tr>
                  <td data-label="Place" style="font-weight: 700;">${result.placement || '‚Äî'}</td>
                  <td data-label="Athlete" style="font-weight: 600;">
                    <a href="athlete.html?id=${result.athlete_id}">${result.athlete_name}</a>
                  </td>
                  <td data-label="School">${result.athlete_school}</td>
                  <td data-label="Mark" style="font-weight: 600;">${formatMark(result.mark)}</td>
                  <td data-label="Heat">${result.heat || '‚Äî'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;

      resultsBox.innerHTML = tableHTML;
    }

    function renderTeamResults(teamScores) {
      const resultsBox = document.getElementById('results-box');

      const teamHTML = `
        <div class="results-table-container">
          <h3>üèÜ Team Scores</h3>
          <table class="results-table">
            <thead>
              <tr>
                <th>Place</th>
                <th>School</th>
                <th>Team Score</th>
                <th>Athletes</th>
              </tr>
            </thead>
            <tbody>
              ${teamScores.map((team, index) => `
                <tr>
                  <td data-label="Place" style="font-weight: 700;">${index + 1}</td>
                  <td data-label="School" style="font-weight: 600;">${team.school}</td>
                  <td data-label="Team Score" style="font-weight: 700; color: #0056b3; font-size: 1.1rem;">${team.score}</td>
                  <td data-label="Athletes">${team.athletes}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;

      resultsBox.innerHTML = teamHTML + resultsBox.innerHTML;
    }

    // ==========================================
    // WEATHER WIDGET FUNCTIONS
    // ==========================================

    const schoolCoordinatesMap = {
      'grafton high school': { lat: 39.34, lon: -80.03 },
      'parkersburg high school': { lat: 39.27, lon: -81.56 },
      'morgantown high school': { lat: 39.64, lon: -79.96 },
      'bridgeport high school': { lat: 39.29, lon: -80.26 },
      'buckhannon sampson high school': { lat: 38.99, lon: -80.23 },
      'cabell midland high school': { lat: 38.54, lon: -82.45 },
      'huntington high school': { lat: 38.42, lon: -82.45 },
      'hurricane high school': { lat: 38.49, lon: -82.48 },
      'martinsburg high school': { lat: 39.47, lon: -77.97 },
      'university high school': { lat: 39.64, lon: -79.96 }
    };

    function getCoordinatesForLocation(location) {
      if (!location) return null;
      const normalized = location.toLowerCase().trim();
      return schoolCoordinatesMap[normalized] || null;
    }

    async function loadWeatherForMeet(location, meetDate) {
      try {
        const weatherWidget = document.getElementById('weather-widget');
        const coordinates = getCoordinatesForLocation(location);
        
        if (!coordinates) return;

        const meetDateObj = new Date(meetDate);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const weatherDate = meetDateObj <= today ? 'today' : meetDate;

        const weather = await fetchWeatherData(coordinates.lat, coordinates.lon, weatherDate);
        
        if (weather) {
          weatherWidget.style.display = 'block';
          renderWeatherWidget(weather, location, weather.isTodayWeather);
        }
      } catch (err) {
        console.error('Weather error:', err);
      }
    }

    async function fetchWeatherData(lat, lon, dateOrType) {
      try {
        const response = await fetch(
          `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min,weather_code,precipitation_sum,wind_speed_10m_max&temperature_unit=fahrenheit&timezone=auto`
        );
        const data = await response.json();
        
        if (data.daily) {
          const dailyData = data.daily;
          let weatherIndex = 0;
          let isTodayWeather = true;
          
          if (dateOrType !== 'today') {
            const foundIndex = dailyData.time.indexOf(dateOrType);
            if (foundIndex !== -1) {
              weatherIndex = foundIndex;
              isTodayWeather = false;
            }
          }
          
          return {
            date: dateOrType === 'today' ? dailyData.time[0] : dateOrType,
            maxTemp: dailyData.temperature_2m_max[weatherIndex],
            minTemp: dailyData.temperature_2m_min[weatherIndex],
            weatherCode: dailyData.weather_code[weatherIndex],
            precipitation: dailyData.precipitation_sum[weatherIndex],
            windSpeed: dailyData.wind_speed_10m_max[weatherIndex],
            isTodayWeather: isTodayWeather
          };
        }
        return null;
      } catch (err) {
        console.error('Weather fetch error:', err);
        return null;
      }
    }

    function getWeatherDetails(code) {
      const weatherMap = {
        0: { icon: '‚òÄÔ∏è', description: 'Clear' },
        1: { icon: 'üå§Ô∏è', description: 'Mostly Clear' },
        2: { icon: '‚õÖ', description: 'Partly Cloudy' },
        3: { icon: '‚òÅÔ∏è', description: 'Overcast' },
        45: { icon: 'üå´Ô∏è', description: 'Foggy' },
        51: { icon: 'üå¶Ô∏è', description: 'Drizzle' },
        61: { icon: 'üåßÔ∏è', description: 'Rain' },
        80: { icon: 'üåßÔ∏è', description: 'Showers' },
        95: { icon: '‚õàÔ∏è', description: 'Thunderstorm' }
      };
      
      return weatherMap[code] || { icon: '‚ùì', description: 'Unknown' };
    }

    function renderWeatherWidget(weather, location, isTodayWeather) {
      const widget = document.getElementById('weather-widget');
      const { icon, description } = getWeatherDetails(weather.weatherCode);
      
      const maxTemp = Math.round(weather.maxTemp);
      const minTemp = Math.round(weather.minTemp);
      const windSpeed = Math.round(weather.windSpeed);
      const precipitation = Math.round(weather.precipitation * 100) / 100;
      
      const weatherLabel = isTodayWeather ? 'üìç Current Weather' : '‚õÖ Meet Day Forecast';
      
      widget.innerHTML = `
        <div class="weather-content">
          <div class="weather-icon">${icon}</div>
          <div class="weather-info">
            <div class="weather-label">${weatherLabel}</div>
            <div class="weather-location">üåç ${location}</div>
            <div class="weather-conditions">${description}</div>
            <div class="weather-temps">
              <span class="temp-high">${maxTemp}¬∞F</span>
              <span class="temp-divider">/</span>
              <span class="temp-low">${minTemp}¬∞F</span>
            </div>
            <div class="weather-details">
              <span class="detail-item">üí® ${windSpeed} mph</span>
              <span class="detail-item">üíß ${precipitation}"</span>
            </div>
            <div class="weather-timestamp">Updated: ${new Date().toLocaleTimeString()}</div>
          </div>
        </div>
      `;
    }
  </script>
</body>
</html>
